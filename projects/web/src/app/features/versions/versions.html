<div class="wrap">
    <div class="header">
        <a [routerLink]="['/app']">← Proyectos</a>
        <h1>Versiones</h1>
        <a [routerLink]="['/app/projects', projectId(), 'editor']">Ir al editor</a>
    </div>

    <div class="grid">
        <!-- Ramas -->
        <div class="col">
            <h3>Ramas</h3>
            <ul class="list">
                <li *ngFor="let b of branches()" [class.sel]="b.id===branchId()" (click)="selectBranch(b.id)">
                    {{ b.name }} <span *ngIf="b.isDefault" class="badge">default</span>
                    <div class="muted" *ngIf="b.latestVersion">v:{{ b.latestVersion.id | slice:0:6 }} · {{
                        b.latestVersion.createdAt | date:'short' }}</div>
                </li>
            </ul>

            <form [formGroup]="branchForm" (ngSubmit)="createBranch()">
                <h4>Nueva rama</h4>
                <input placeholder="nombre" formControlName="name" />
                <select formControlName="fromVersionId">
                    <option value="">(desde última de la rama seleccionada)</option>
                    <option *ngFor="let v of versions()" [value]="v.id">v {{ v.id | slice:0:7 }} - {{ v.message||'—' }}
                    </option>
                </select>
                <button [disabled]="branchForm.invalid">Crear rama</button>
            </form>
        </div>

        <!-- Timeline -->
        <div class="col">
            <h3>Timeline</h3>
            <ul class="list">
                <li *ngFor="let v of versions()" (click)="selectVersion(v.id)" [class.sel]="v.id===selectedVersionId()">
                    <b>v{{ v.id | slice:0:7 }}</b> · {{ v.createdAt | date:'short' }} · {{ v.author?.name ||
                    v.author?.email || '—' }}
                    <div class="muted">{{ v.message || '—' }}</div>
                </li>
            </ul>
        </div>

        <!-- Operaciones -->
        <div class="col">
            <h3>Operaciones</h3>

            <section>
                <h4>Diff</h4>
                <label>Desde
                    <select [value]="diffFromId()" #fromSel (change)="diffFromId.set(fromSel.value)">
                        <option *ngFor="let v of versions()" [value]="v.id">
                            v {{ v.id | slice:0:7 }} - {{ v.message || '—' }}
                        </option>
                    </select>
                </label>
                <label>Hasta
                    <select [value]="diffToId()" #toSel (change)="diffToId.set(toSel.value)">
                        <option *ngFor="let v of versions()" [value]="v.id">
                            v {{ v.id | slice:0:7 }} - {{ v.message || '—' }}
                        </option>
                    </select>
                </label>
                <button (click)="runDiff()" [disabled]="!diffFromId() || !diffToId()">Comparar</button>
                <div *ngIf="diffRes()">
                    <pre class="pre">{{ diffRes().summary | json }}</pre>
                </div>
            </section>

            <section>
                <h4>Restore</h4>
                <button (click)="restore()" [disabled]="!selectedVersionId()">Restaurar a versión seleccionada</button>
            </section>

            <section>
                <h4>Merge</h4>
                <label>Origen (branch)
                    <select [value]="mergeSourceBranchId()" #srcBranch (change)="onPickSourceBranch(srcBranch.value)">
                        <option *ngFor="let b of branches()" [value]="b.id">{{ b.name }}</option>
                    </select>
                </label>
                <label>Versión origen
                    <select [value]="mergeSourceVersionId()" #srcVer (change)="mergeSourceVersionId.set(srcVer.value)">
                        <option *ngFor="let v of mergeSourceVersions()" [value]="v.id">
                            {{ v.id | slice:0:7 }} - {{ v.message || '—' }}
                        </option>
                    </select>
                </label>
                <label>Destino (branch)
                    <select [value]="branchId()" disabled>
                        <option [value]="branchId()">{{ branchName(branchId()) }}</option>
                    </select>
                </label>
                <label>Versión destino
                    <select [value]="selectedVersionId()" #dstVer (change)="selectVersion(dstVer.value)">
                        <option *ngFor="let v of versions()" [value]="v.id">
                            {{ v.id | slice:0:7 }} - {{ v.message || '—' }}
                        </option>
                    </select>
                </label>
                <button (click)="runMerge()" [disabled]="!mergeSourceVersionId() || !selectedVersionId()">Merge →
                    destino</button>

                <div *ngIf="mergeRes()">
                    <p>Estado: <b>{{ mergeRes().status }}</b></p>
                    <div *ngIf="mergeRes().conflicts?.length">
                        <details>
                            <summary>Conflictos ({{ mergeRes().conflicts.length }})</summary>
                            <pre class="pre">{{ mergeRes().conflicts | json }}</pre>
                        </details>
                    </div>
                </div>
            </section>
        </div>
    </div>
</div>